/*! TabularBells - v0.0.3 - 2013-03-08
* http://www.github.com/svjson/TabularBells/
* Copyright (c) 2013 Sven Johansson; Licensed MIT */
var TabularBells=TabularBells||{},TB=TB||TabularBells;TB.Class=function(e){var t=function(e){for(var t in e)this[t]=e[t];this.init.apply(this,arguments)};return t.prototype.init=function(){},t.fn=t.prototype,t.fn.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},t.sub=function(e){},t.sub=function(e){var t={};for(var n in this.fn)t[n]=this.fn[n];for(var n in e)t[n]=e[n];return new TB.Class(t)},t.include=function(e){typeof e=="function"&&(e=e());for(var n in e)t.fn[n]=e[n]},e&&t.include(e),t},TB.Events=function(){return{listeners:null,trigger:function(e,t){this.getHandlers(e).forEach(function(e){e(t)})},bind:function(e,t){this.getHandlers(e).push(t)},getHandlers:function(e){return this.listeners=this.listeners||{},this.listeners[e]||(this.listeners[e]=[]),this.listeners[e]}}},TB.DataSource=new TB.Class({data:[],filter:null,init:function(){},size:function(e){return e&&e(this.data.length),this.data.length},initialize:function(e){e()},applyFilter:function(e){this.filter||(this.filter={}),!e.filter||e.filter.length==0?delete this.filter[e.index]:this.filter[e.index]=e.filter,this.filteredData=null,this.trigger("data-changed",this.data)},getFilteredData:function(){return null==this.filteredData&&this.filterData(),this.filteredData},filterData:function(){var e=[];this.data.forEach(this.proxy(function(t){this.matchesFilter(t)&&e.push(t)})),this.filteredData=e},matchesFilter:function(e){for(var t in this.filter){var n=t,r=this.filter[t];if(!e[n])return!1;var i=r.toLowerCase(),s=e[n].toLowerCase();if(s.indexOf(i)!=0)return!1}return!0},isFilterActive:function(){if(!this.filter)return!1;for(var e in this.filter)return!0;return!1}}),TB.DataSource.include(TB.Events),TB.ArrayDataSource=TB.DataSource.sub({init:function(e){e&&(this.data=e)},get:function(e,t){var n=this.data;this.isFilterActive()&&(n=this.getFilteredData());if(e.from>n.length)return[];if(!e.size)return n;var r=e.from,i=e.from+e.size;return i>n.length&&(i=n.length),t&&t(n.slice(r,i)),n.slice(r,i)},loadData:function(e){this.data=e,this.trigger("data-changed",e)}}),TB.DataSource.include(TB.Events),TB.AjaxDataSource=TB.DataSource.sub({data:[],baseUrl:null,pageParameter:"page",pageSizeParameter:"pageSize",dataSetSize:null,dataPath:"data",sizePath:"size",init:function(){},initialize:function(e){this.size(this.proxy(function(){e()}))},get:function(e,t){this.trigger("loading-initiated"),$.getJSON(this.baseUrl+"?page="+e.page+"&pageSize="+e.size,this.proxy(function(e){this.dataSetSize=this.getValueAtObjectPath(this.sizePath,e),t(this.getValueAtObjectPath(this.dataPath,e))}))},getValueAtObjectPath:function(e,t){var n=t;return e.split(".").forEach(function(e){n=n[e]}),n},size:function(e){this.dataSetSize?e(this.dataSetSize):this.get({from:1,page:1,size:1},this.proxy(function(){e(this.dataSetSize)}))}}),TB.PaginationView=new TB.Class({render:function(e){},selectPage:function(e){}}),TB.PaginationView.include(TB.Events),TB.NoPaginationView=TB.PaginationView.sub({}),TB.JQueryTemplatePaginationView=TB.PaginationView.sub({paginationBarTemplate:'<div>{{each(idx,p) pages}} <a class="pagination-page" href="#" data-page="${idx+1}">[${idx+1}</a>] {{/each}}</div>',target:null,render:function(e){this.target.html(""),e.pages>1&&$(this.paginationBarTemplate).tmpl({pages:new Array(e.pages)}).appendTo(this.target),this.target.find(".pagination-page").on("click",this.proxy(function(e){e.preventDefault();var t=parseInt($(e.currentTarget).attr("data-page"));return this.trigger("page-requested",{pageNumber:t}),!1})),this.target.find(".pgn-prev").on("click",this.proxy(function(e){return e.preventDefault(),this.trigger("page-step",-1),!1})),this.target.find(".pgn-next").on("click",this.proxy(function(e){return e.preventDefault(),this.trigger("page-step",1),!1})),this.selectPage(e.currentPage)}}),TB.PaginationStrategy=new TB.Class({pageSize:20,currentPage:1,view:new TB.NoPaginationView,initialize:function(e){e.size(this.proxy(function(e){this.maxPage=Math.ceil(e/this.pageSize),this.currentPage>this.maxPage&&(this.currentPage=this.maxPage),this.currentPage==0&&(this.currentPage=1),this.view.render({pageSize:this.pageSize,dataSetSize:e,pages:this.maxPage,currentPage:this.currentPage})}))}}),TB.PaginationStrategy.include(TB.Events),TB.NoPagination=TB.PaginationStrategy.sub({maxResults:50,getPageQuery:function(){return{from:0,page:1}}}),TB.PaginationBar=TB.PaginationStrategy.sub({init:function(){this.view.bind("page-requested",this.proxy(function(e){this.selectPage(e.pageNumber)})),this.view.bind("page-step",this.proxy(function(e){this.selectPage(this.currentPage+e)}))},selectPage:function(e){if(e<=0||e>this.maxPage)return;this.currentPage=e,this.trigger("pagination-changed"),this.view.selectPage(this.currentPage)},getPageQuery:function(){return{from:(this.currentPage-1)*this.pageSize,page:this.currentPage,size:this.pageSize}}}),TB.BasicColumnModel=new TB.Class({actionsHeader:"Actions",renderCell:function(e,t){var n=this.columns[t];return n.renderFn?n.renderFn(e[n.index],e):e[n.index]},showActions:function(){return this.actions!=null&&this.actions.length>0},visibleColumns:function(){var e=0;return this.columns.forEach(function(t){t.hidden||e++}),this.showActions()&&e++,e}}),TB.TableView=new TB.Class({currentDataSet:[],init:function(){},initialize:function(e){this.render({columnModel:e,data:[]})},render:function(e){},showLoadingStatus:function(){},updateRows:function(e){this.currentDataSet=e.data},invokeAction:function(e,t){this.trigger("action-requested",{action:e,row:this.currentDataSet[t]})}}),TB.TableView.include(TB.Events),TB.JQueryTemplateView=TB.TableView.sub({target:null,tableTemplate:'<table><tr class="header-row"></tr></table>',noDataTemplate:"No content",loadingTemplate:"Loading...",headerTemplate:'<th data-index="${index}">{{html header}}</th>',filterTemplate:'<small> (<a href="#" class="filter-trigger">filter</a>)</small>',noContentRow:'<tr class="no-content-row"><td colspan="${noofColumns}">{{html noDataTemplate}}</td></tr>',rowTemplate:'{{each(i,row) data}}    <tr class="data-row">      {{each(idx,col) columnModel.columns}}        {{if !col.hidden}}          <td>{{html columnModel.renderCell(row, idx)}}</td>        {{/if}}      {{/each}}      {{if columnModel.showActions()}}        <td>          {{html layoutActions(columnModel, row)}}        </td>      {{/if}}    </tr>  {{/each}}',actionsTemplate:"{{each(idx,action) columnModel.actions}}      {{html actionFormatter(action)}}    {{/each}}",actionTemplate:'<a href="#" class="action-link" data-action-id="${action.id}">${action.label}</a>',columnFilterTemplate:'<div id="column-popup-wrapper"><div id="column-popup"><input class="column-filter-input" data-column-index="${index}" type="text" /></div></div>',layoutActions:function(e,t){var n=$("<span></span>");return $(this.wrap(this.actionsTemplate)).tmpl({columnModel:e,row:t,actionFormatter:this.proxy(this.actionFormatter)}).appendTo(n),n.html()},actionFormatter:function(e){var t=$("<span></span>");return $(this.wrap(this.actionTemplate)).tmpl({action:e}).appendTo(t),t.html()},init:function(){},render:function(e){this.numberOfColumns=e.columnModel.visibleColumns(),$(this.wrap(this.tableTemplate)).tmpl().appendTo(this.target),e.columnModel.columns.forEach(this.proxy(function(e){if(!e.hidden){var t=e.header;e.columnFilter&&(t+=this.filterTemplate),$(this.wrap(this.headerTemplate)).tmpl({header:t,index:e.index}).appendTo(this.target.find(".header-row"))}})),e.columnModel.showActions()&&$(this.wrap(this.headerTemplate)).tmpl({header:e.columnModel.actionsHeader}).appendTo(this.target.find(".header-row")),e.data&&this.updateRows(e),this.target.on("click",".action-link",this.proxy(function(e){e.preventDefault();var t=$(e.currentTarget),n=t.attr("data-action-id"),r=t.closest("tr").index()-1;return this.invokeAction(n,r),!1})),this.bindColumnFilterPopovers(e)},updateRows:function(e){this.currentDataSet=e.data,e.data.length==0?this.showNoContentStatus():(this.target.find(".no-content-row").remove(),this.target.find(".data-row").remove(),$(this.wrap(this.rowTemplate)).tmpl($.extend({layoutActions:this.proxy(this.layoutActions)},e)).appendTo(this.target.find("table tbody")))},showNoContentStatus:function(){this.showEmptyStatus(this.noDataTemplate)},showLoadingStatus:function(){this.showEmptyStatus(this.loadingTemplate)},showEmptyStatus:function(e){this.target.find(".no-content-row").remove(),this.target.find(".data-row").remove(),$(this.wrap(this.noContentRow)).tmpl({noofColumns:this.numberOfColumns,noDataTemplate:e}).appendTo(this.target.find("table tbody"))},bindColumnFilterPopovers:function(e){alert("ColumnFilter is not implemented in this view implementation")},wrap:function(e){return"<script>"+e+"</script>"}}),TB.Table=new TB.Class({view:null,dataSource:null,columnModel:null,paginationStrategy:new TB.NoPagination,init:function(){this.initialize()},initialize:function(){this.initializeDataSource(this.proxy(function(){this.initializeView(),this.initializePagination(),this.paginationStrategy.bind("pagination-changed",this.proxy(this.refreshTable)),this.dataSource.bind("data-changed",this.proxy(this.initializePagination)),this.dataSource.bind("data-changed",this.proxy(this.refreshTable)),this.dataSource.bind("loading-initiated",this.proxy(this.showLoadingStatus)),this.view.bind("column-filter-updated",this.proxy(this.columnFilterUpdated))}))},refreshTable:function(){this.dataSource.get(this.paginationStrategy.getPageQuery(),this.proxy(function(e){this.view.updateRows({data:e,columnModel:this.columnModel})}))},showLoadingStatus:function(){this.view.showLoadingStatus()},initializeView:function(){if(!this.view)throw new Error("No view specified.");this.view.initialize(this.columnModel),this.refreshTable()},initializeDataSource:function(e){this.dataSource||(this.dataSource=new TB.ArrayDataSource([])),this.dataSource.initialize(e)},initializePagination:function(){this.paginationStrategy.initialize(this.dataSource)},bindAction:function(e,t){this.view.bind("action-requested",this.proxy(function(n){n.action===e&&t(n.row)}))},columnFilterUpdated:function(e){this.dataSource.applyFilter(e)}}),TB.Table.include(TB.Events),TB.BootstrapTable=TB.Table.sub({init:function(){this.view=new TB.BootstrapTableTemplateView({target:this.tableElement,noDataTemplate:this.noDataTemplate?this.noDataTemplate:"No content",loadingTemplate:this.loadingTemplate?this.loadingTemplate:"Loading...",actionData:this.actionData?this.actionData:{}}),this.paginationStrategy=new TB.PaginationBar({view:new TB.BootstrapPaginationTemplateView({target:this.paginationElement}),pageSize:this.pageSize}),this.initialize()}}),TB.BootstrapTableTemplateView=TB.JQueryTemplateView.sub({tableTemplate:'<table class="table table-condensed table-striped" cellpadding="0" cellspacing="0" width="100%"><tr class="header-row"> </tr> </table>',actionsTemplate:'<div class="actions"><ul style="list-style-type: none;">{{each(idx,action) columnModel.actions}}    {{html actionFormatter(action)}}  {{/each}}</ul></div>',filterTemplate:'<a href="#" rel="popover" class="filter-trigger"><i class="icon-large icon-filter" /></a>',actionData:{},actionTemplate:'<li style="display: inline"><a href="#" class="action-link" data-action-id="${action.id}"><i class="${actionData[action.id]} icon-large" title="${action.label}"></i></a></li>',actionFormatter:function(e){var t=$("<span></span>");return $(this.wrap(this.actionTemplate)).tmpl({action:e,actionData:this.actionData}).appendTo(t),t.html()},bindColumnFilterPopovers:function(e){var t=this.target.find("th .filter-trigger");t.each(this.proxy(function(e,t){t=$(t),t.popover({title:"Column filter",placement:"bottom",content:$(this.columnFilterTemplate).tmpl({index:t.closest("th").attr("data-index")}),html:!0})})),this.target.on("keyup",".column-filter-input",this.proxy(function(e){var t=$(e.currentTarget),n=t.attr("data-column-index"),r=t.val();this.trigger("column-filter-updated",{index:n,filter:r})}))}}),TB.BootstrapPaginationTemplateView=TB.JQueryTemplatePaginationView.sub({paginationBarTemplate:'<div class="pagination-bar">      <div class="pagination pagination-centered">        <ul>          <li><a style="margin-left: 10px" href="#" class="pgn-prev" title="Previous Page">&laquo;</a></li>          {{each(idx,p) pages}} <li><a class="number pagination-page" href="#" data-page="${idx+1}">${idx+1}</a></li>{{/each}}          <li><a style="margin-right: 10px" href="#" class="pgn-next" title="Next Page">&raquo;</a></li>        </ul>     </div>   </div>',selectPage:function(e){this.target.find("li").removeClass("active"),this.target.find('a[data-page="'+e+'"]').parent("li").addClass("active")}});